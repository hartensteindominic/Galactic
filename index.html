<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sentinel v6.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root { --neon: #00f2ff; --bg: #000; --err: #ff4444; }
        body { background: var(--bg); color: var(--neon); font-family: monospace; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #v { position: absolute; top: 10px; right: 10px; width: 80px; height: 60px; border: 1px solid #333; transform: scaleX(-1); border-radius: 4px; }
        #canvas-container { width: 300px; height: 300px; }
        .controls { position: absolute; bottom: 40px; width: 85%; display: flex; flex-direction: column; gap: 12px; }
        .btn { background: #111; border: 2px solid var(--neon); color: var(--neon); padding: 18px; font-weight: bold; font-size: 1rem; cursor: pointer; border-radius: 2px; }
        #msg { font-size: 0.75rem; text-align: center; min-height: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .err-text { color: var(--err); border-color: var(--err); }
    </style>
</head>
<body>

<video id="v" autoplay playsinline muted></video>
<div id="canvas-container"></div>

<div class="controls">
    <div id="msg">AWAITING SYSTEM INITIALIZATION</div>
    <button id="mainBtn" class="btn">ACTIVATE SENTINEL</button>
</div>

<script>
    const btn = document.getElementById('mainBtn');
    const msg = document.getElementById('msg');
    let sphere;

    // 1. Setup Graphics
    function init3D() {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(300, 300);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        const geo = new THREE.IcosahedronGeometry(1.5, 3);
        const mat = new THREE.MeshBasicMaterial({ color: 0x00f2ff, wireframe: true });
        sphere = new THREE.Mesh(geo, mat);
        scene.add(sphere);
        camera.position.z = 3.5;
        const animate = () => {
            requestAnimationFrame(animate);
            sphere.rotation.y += 0.01;
            if (window.speechSynthesis.speaking) {
                let s = 1.1 + Math.random() * 0.2;
                sphere.scale.set(s,s,s);
            } else { sphere.scale.set(1,1,1); }
            renderer.render(scene, camera);
        };
        animate();
    }

    // 2. The AI Voice "Prime" (Vital for Mobile)
    function speak(text) {
        window.speechSynthesis.cancel();
        const ssu = new SpeechSynthesisUtterance(text);
        // iOS 26 requires a very specific voice property check
        const voices = window.speechSynthesis.getVoices();
        if (voices.length > 0) {
            ssu.voice = voices.find(v => v.lang.includes('en')) || voices[0];
        }
        ssu.pitch = 0.6;
        ssu.rate = 0.8;
        window.speechSynthesis.speak(ssu);
    }

    // 3. Activation Flow
    btn.onclick = async () => {
        msg.innerText = "INITIALIZING...";
        
        // A. Start Audio First (Unlocks browser)
        speak("Sentinel online. Bio-link confirmed.");
        
        // B. Start 3D
        if (!sphere) init3D();

        // C. Start Camera with specific Mobile constraints
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user", width: 320 } 
            });
            document.getElementById('v').srcObject = stream;
            msg.innerText = "SYSTEM: FULLY OPERATIONAL";
            btn.innerText = "RE-CALIBRATE AUDIO"; // Change button to audio fix
        } catch (e) {
            msg.innerText = "ERROR: " + (window.isSecureContext ? "CAMERA BLOCKED" : "HTTPS REQUIRED");
            msg.classList.add('err-text');
            btn.innerText = "RETRY SENSORS";
        }
    };

    // Pre-warm the voice list
    window.speechSynthesis.onvoiceschanged = () => { console.log("Voices Ready"); };
</script>
</body>
</html>
