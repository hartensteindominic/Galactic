<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>

<style>
    /* THE FORGE: SPLIT-SCREEN LAYOUT */
    #editor-view { display: none; height: 100%; flex-direction: column; background: #000; }
    .forge-container { display: flex; flex: 1; overflow: hidden; border-top: 1px solid var(--border); }
    
    /* LEFT SIDE: THE CODE */
    #code-editor-pane { flex: 1; border-right: 1px solid var(--border); background: #0a0a0a; position: relative; overflow: auto; }
    
    /* RIGHT SIDE: THE LIVE PREVIEW */
    #preview-pane { flex: 1; background: white; position: relative; }
    #live-iframe { width: 100%; height: 100%; border: none; }

    /* REAL-TIME STATUS INDICATOR */
    .status-bar { padding: 5px 15px; background: #161616; color: #737373; font-size: 10px; font-weight: 800; display: flex; justify-content: space-between; }
    .sync-active { color: #10b981; } /* Green glow when syncing */
</style>

<script>
    let editor; // Global editor instance

    // INITIALIZE THE FORGE
    function openTheForge(code) {
        document.getElementById('portal-page').style.display = 'none';
        document.getElementById('project-view').style.display = 'none';
        document.getElementById('editor-view').style.display = 'flex';

        // Set up the code editor if not already initialized
        if (!editor) {
            const editorEl = document.getElementById('code-editor-pane');
            editorEl.innerHTML = ""; // Clear loader
            
            // Textarea-based sync for maximum stability across devices
            editor = document.createElement('textarea');
            editor.style = "width:100%; height:100%; background:transparent; color:#10b981; border:none; padding:20px; font-family:monospace; font-size:14px; outline:none; resize:none;";
            editorEl.appendChild(editor);

            // LIVE SYNC: Updates on every keystroke
            editor.addEventListener('input', () => {
                updateLivePreview(editor.value);
            });
        }

        editor.value = code;
        updateLivePreview(code);
    }

    function updateLivePreview(code) {
        const iframe = document.getElementById('live-iframe');
        const blob = new Blob([code], { type: 'text/html' });
        iframe.src = URL.createObjectURL(blob);
        
        // Update Vault with the new manual tweaks
        saveBuildToVault({ topic: "Manual Edit", code: code, time: new Date().toLocaleTimeString() });
    }
</script>
