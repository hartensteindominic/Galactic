<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURUM SENTINEL // ZENITH_V40</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #FFD700; font-family: 'Courier New', monospace; overflow: hidden; touch-action: manipulation; }
        #canvas-bg { position: fixed; top: 0; left: 0; z-index: -1; }
        .glass { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(15px); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 2px; }
        .gadget { position: absolute; padding: 10px; z-index: 20; }
        .main-vault { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 400px; padding: 20px; z-index: 50; border-top: 2px solid #FFD700; }
        .vault-btn { width: 100%; padding: 12px; font-weight: 900; font-size: 9px; text-transform: uppercase; cursor: pointer; border: 1px solid #FFD700; background: transparent; color: #FFD700; transition: 0.3s; margin-top: 8px; }
        .vault-btn:hover:not(:disabled) { background: #FFD700; color: #000; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
        .vault-btn:disabled { opacity: 0.2; cursor: not-allowed; }
        input { background: rgba(255,255,255,0.03) !important; border-bottom: 1px solid rgba(255,215,0,0.2) !important; color: white; width: 100%; padding: 10px; font-size: 11px; outline: none; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .pulse { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        #terminal-feed::-webkit-scrollbar { display: none; }
        .toast { background: #000; border: 1px solid #FFD700; padding: 10px; color: #FFD700; font-size: 9px; min-width: 200px; animation: slideIn 0.3s ease-out; pointer-events: auto; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<canvas id="canvas-bg"></canvas>
<div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2 pointer-events-none"></div>

<div class="gadget glass top-6 left-6 w-44">
    <div class="text-[7px] text-cyan-400 font-bold mb-1 tracking-widest uppercase">Kernel_Auditor</div>
    <div class="text-[9px] text-white font-bold">LIDO_V3_ACTIVE</div>
    <div class="flex items-center mt-1">
        <span class="status-dot bg-green-500 pulse"></span>
        <span id="gas-display" class="text-[6px] text-green-400">GAS: -- GWEI</span>
    </div>
</div>

<div class="gadget glass bottom-6 left-6 w-52">
    <div class="text-[7px] opacity-40 uppercase mb-2 tracking-widest border-b border-white/10 pb-1">Vizier_Rankings</div>
    <div id="leader-list" class="space-y-1.5 text-[8px]">
        <div class="animate-pulse text-white/20">FETCHING_BLOCKCHAIN_DATA...</div>
    </div>
</div>

<div class="main-vault glass">
    <div class="flex justify-between items-center mb-6">
        <span class="text-[10px] font-black tracking-[0.3em]">ZENITH_PROTOCOL</span>
        <button id="btn-connect" onclick="syncSystem()" class="text-[7px] border border-[#FFD700] px-2 py-1 font-bold uppercase hover:bg-[#FFD700] hover:text-black transition-all">Link_Wallet</button>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-6">
        <div class="p-2 bg-white/5">
            <span class="text-[6px] opacity-40 block uppercase">Wallet_ETH</span>
            <span id="user-eth" class="text-xs font-bold tracking-widest text-white">0.0000</span>
        </div>
        <div class="p-2 bg-white/5 border-l-2 border-[#FFD700]">
            <span class="text-[6px] opacity-40 block uppercase">Staked_stETH</span>
            <span id="user-steth" class="text-xs font-bold tracking-widest text-[#FFD700]">0.0000</span>
        </div>
    </div>

    <input id="stake-input" type="number" step="0.1" placeholder="ENTER TRIBUTE AMOUNT">
    
    <div class="mt-4">
        <button id="btn-stake" onclick="stakeEth()" class="vault-btn font-black" disabled>Awaiting_Sync</button>
        <button id="btn-withdraw" onclick="requestWithdrawal()" class="vault-btn border-cyan-500 text-cyan-400 hover:bg-cyan-500 hover:text-black text-[8px]" disabled>Withdraw (Request NFT)</button>
    </div>

    <div id="claim-section" class="mt-4 p-2 border border-green-500/30 bg-green-500/5 hidden">
        <button onclick="claimAll()" class="vault-btn border-green-400 text-green-400 text-[8px] hover:bg-green-400 hover:text-black">Finalize & Claim ETH</button>
    </div>

    <div class="mt-6 border-t border-white/10 pt-4">
        <div class="text-[7px] opacity-40 uppercase mb-2 flex justify-between">
            <span>Kernel_Log</span>
            <span id="log-clock">00:00:00</span>
        </div>
        <div id="terminal-feed" class="h-16 overflow-y-auto pr-2 space-y-1">
            <div class="text-[7px] text-cyan-500/50">[SYSTEM] Initialization Complete.</div>
        </div>
        <div id="ai-thought" class="mt-3 text-[7px] text-cyan-400 text-center italic uppercase tracking-tighter">"System Ready. Awaiting Signature."</div>
    </div>
</div>

<script>
    const CONFIG = {
        TREASURY: "0x13B87B819252A81381C3Ce35e3Bd33199F4c6650",
        LIDO: "0xae7ab96520DE3A18E5e111B5EaAb095312D7fE84",
        WITHDRAWAL_QUEUE: "0x889edC2eDab5f40e902b864aD4d7AdE8E412F9B1",
        ETHERSCAN_KEY: "FREE_KEY"
    };

    let signer = null; let provider = null;

    // --- ðŸŽ¨ 3D ENGINE ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas-bg'), alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    const knot = new THREE.Mesh(new THREE.TorusKnotGeometry(12, 3, 100, 16), new THREE.MeshBasicMaterial({ color: 0xFFD700, wireframe: true, transparent: true, opacity: 0.1 }));
    scene.add(knot); camera.position.z = 40;
    function animate() { requestAnimationFrame(animate); knot.rotation.y += 0.001; renderer.render(scene, camera); } animate();

    // --- ðŸ“‹ LOG SYSTEM ---
    function logEvent(msg, type = "system") {
        const feed = document.getElementById('terminal-feed');
        const colors = { system: "text-cyan-500/50", action: "text-[#FFD700]", success: "text-green-400", error: "text-red-500" };
        const entry = document.createElement('div');
        entry.className = `text-[7px] ${colors[type]}`;
        entry.innerHTML = `[${new Date().toLocaleTimeString('en-GB')}] ${msg}`;
        feed.prepend(entry);
    }

    function notify(msg, type = "info") {
        const id = "t-" + Date.now();
        const toast = document.createElement('div');
        toast.className = "toast";
        toast.innerHTML = `<div class="font-bold uppercase">[${type}]</div><div>${msg}</div>`;
        document.getElementById('toast-container').appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
        return id;
    }

    // --- ðŸ”— BLOCKCHAIN CORE ---
    async function syncSystem() {
        if (!window.ethereum) return logEvent("MetaMask Not Found", "error");
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            const net = await provider.getNetwork();
            if (net.chainId !== 1n) return logEvent("Switch to Ethereum Mainnet", "error");

            const accounts = await provider.send("eth_requestAccounts", []);
            signer = await provider.getSigner();
            
            document.getElementById('btn-connect').innerText = accounts[0].slice(0,6);
            document.getElementById('btn-stake').disabled = false;
            document.getElementById('btn-stake').innerText = "Stake into Lido Core";
            document.getElementById('btn-withdraw').disabled = false;

            const ethBal = await provider.getBalance(accounts[0]);
            document.getElementById('user-eth').innerText = parseFloat(ethers.formatUnits(ethBal, 18)).toFixed(4);

            const lido = new ethers.Contract(CONFIG.LIDO, ["function balanceOf(address) view returns (uint256)"], provider);
            const stEthBal = await lido.balanceOf(accounts[0]);
            document.getElementById('user-steth').innerText = parseFloat(ethers.formatUnits(stEthBal, 18)).toFixed(4);

            logEvent("Kernel Synced: " + accounts[0].slice(0,10), "success");
            updateRankings();
            checkClaimable();
        } catch(e) { logEvent("Sync Refused", "error"); }
    }

    async function stakeEth() {
        const val = document.getElementById('stake-input').value;
        if(!val || val <= 0) return;
        logEvent("Initiating Stake: " + val + " ETH", "action");
        try {
            const lido = new ethers.Contract(CONFIG.LIDO, ["function submit(address) payable"], signer);
            const tx = await lido.submit(CONFIG.TREASURY, { value: ethers.parseEther(val) });
            notify("Stake Processing...", "processing");
            await tx.wait();
            logEvent("Stake Confirmed", "success");
            syncSystem();
        } catch(e) { logEvent("Stake Cancelled", "error"); }
    }

    async function requestWithdrawal() {
        const val = document.getElementById('stake-input').value;
        if(!val || val <= 0) return;
        logEvent("Requesting Unstake...", "action");
        try {
            const stETH = new ethers.Contract(CONFIG.LIDO, ["function approve(address, uint256) returns (bool)"], signer);
            const queue = new ethers.Contract(CONFIG.WITHDRAWAL_QUEUE, ["function requestWithdrawals(uint256[], address)"], signer);
            
            logEvent("Step 1: Approving stETH", "system");
            const app = await stETH.approve(CONFIG.WITHDRAWAL_QUEUE, ethers.parseEther(val));
            await app.wait();

            logEvent("Step 2: Queuing Request", "system");
            const tx = await queue.requestWithdrawals([ethers.parseEther(val)], await signer.getAddress());
            await tx.wait();
            logEvent("Withdrawal NFT Issued", "success");
        } catch(e) { logEvent("Withdrawal Aborted", "error"); }
    }

    async function checkClaimable() {
        const queue = new ethers.Contract(CONFIG.WITHDRAWAL_QUEUE, [
            "function getWithdrawalRequests(address) view returns (uint256[])",
            "function getWithdrawalStatus(uint256[]) view returns (tuple(uint256, uint256, address, uint256, bool, bool)[])"
        ], provider);
        const ids = await queue.getWithdrawalRequests(await signer.getAddress());
        if(ids.length === 0) return;
        const stats = await queue.getWithdrawalStatus(ids);
        const ready = ids.filter((id, i) => stats[i][4] && !stats[i][5]);
        if(ready.length > 0) {
            document.getElementById('claim-section').classList.remove('hidden');
            window.readyIds = ready;
        }
    }

    async function claimAll() {
        const queue = new ethers.Contract(CONFIG.WITHDRAWAL_QUEUE, ["function claimWithdrawals(uint256[], uint256[])"], signer);
        const tx = await queue.claimWithdrawals(window.readyIds, new Array(window.readyIds.length).fill(0));
        await tx.wait();
        syncSystem();
    }

    async function updateRankings() {
        try {
            const res = await fetch(`https://api.etherscan.io/api?module=account&action=txlist&address=${CONFIG.LIDO}&offset=5&sort=desc&apikey=${CONFIG.ETHERSCAN_KEY}`);
            const data = await res.json();
            if(data.status !== "1") return;
            document.getElementById('leader-list').innerHTML = data.result.map((tx, i) => `
                <div class="flex justify-between ${i>0?'opacity-40':''}">
                    <span>${tx.from.slice(0,8)}...</span>
                    <span class="${i===0?'text-[#FFD700]':''}">${(tx.value/1e18).toFixed(2)} ETH</span>
                </div>`).join('');
        } catch(e) {}
    }

    setInterval(async () => {
        if(provider) {
            const fee = await provider.getFeeData();
            document.getElementById('gas-display').innerText = `GAS: ${Math.round(ethers.formatUnits(fee.gasPrice, "gwei"))} GWEI`;
        }
        document.getElementById('log-clock').innerText = new Date().toLocaleTimeString('en-GB');
    }, 1000);

    window.onload = syncSystem;
</script>
</body>
</html>
