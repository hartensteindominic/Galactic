<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Sovereign | Recursive Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --bg: #000;
            --card: #111;
            --prime: #fff;
            --blue: #3b82f6;
            --green: #10b981;
            --text: #e5e7eb;
            --border: #262626;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        nav {
            padding: 1rem 2rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #000;
            z-index: 10;
        }
        .status-pill {
            background: var(--card);
            border: 1px solid var(--border);
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 800;
            color: #737373;
        }
        .thinking {
            color: var(--blue);
            border-color: var(--blue);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        #editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }
        #preview-container {
            flex: 1;
            background: #fff;
            position: relative;
        }
        textarea {
            flex: 1;
            background: #000;
            color: var(--green);
            border: none;
            padding: 1.5rem;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            outline: none;
            resize: none;
            line-height: 1.6;
        }
        .toolbar {
            padding: 12px 1.5rem;
            background: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            font-weight: 800;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .btn:hover { opacity: 0.92; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-prime { background: var(--prime); color: #000; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-ghost {
            background: transparent;
            color: #aaa;
            border: 1px solid var(--border);
        }
        .btn-wallet { background: #f59e0b; color: white; }
        #walletAddress { color: #aaa; font-size: 13px; }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>

    <nav>
        <div style="font-weight:900; letter-spacing:-0.5px; font-size:1.3rem;">NEXUS SOVEREIGN</div>
        <div id="status" class="status-pill">ENGINE IDLE</div>
    </nav>

    <main>
        <div id="editor-container">
            <textarea id="editor" placeholder="Your code appears here...&#10;Click REPROGRAM (AI) to evolve it (requires wallet + 0.01 ETH payment)"></textarea>
            <div class="toolbar">
                <button class="btn btn-ghost" id="undoBtn">UNDO</button>
                <button class="btn btn-prime" id="rewriteBtn" disabled>REPROGRAM (AI)</button>
                <button class="btn btn-blue" onclick="downloadCode()">EXPORT</button>
                <button class="btn btn-ghost" id="setKeyBtn">SET API KEY</button>
                <button class="btn btn-wallet" id="connectWalletBtn">CONNECT WALLET</button>
                <span id="walletAddress"></span>
            </div>
        </div>
        <div id="preview-container">
            <iframe id="preview"></iframe>
        </div>
    </main>

    <script>
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const status = document.getElementById('status');
        const rewriteBtn = document.getElementById('rewriteBtn');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletAddressSpan = document.getElementById('walletAddress');

        let history = [];
        // Your provided xAI API key (will be saved to localStorage after first use)
        let XAI_KEY = localStorage.getItem('xai_api_key') || "xai-G7JvL16cDlnBbKrHUxKcwEcsexkOTgFP2phHhGGbkM3ug4uLI2pajIDncuAG3E4IhVyKXVVnrOBglVCs";

        let provider, signer, walletAddress;

        // Live preview update
        editor.addEventListener('input', () => {
            const blob = new Blob([editor.value], { type: 'text/html' });
            preview.src = URL.createObjectURL(blob);
        });

        // Connect MetaMask / Web3 wallet
        async function connectWallet() {
            if (!window.ethereum) {
                status.innerText = "ERROR: No wallet detected (install MetaMask)";
                return;
            }
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                walletAddress = await signer.getAddress();
                walletAddressSpan.innerText = `Connected: ${walletAddress.slice(0,6)}...${walletAddress.slice(-4)}`;
                connectWalletBtn.style.display = 'none';
                rewriteBtn.disabled = false;
                status.innerText = "WALLET CONNECTED";
                setTimeout(() => status.innerText = "ENGINE IDLE", 3000);
            } catch (e) {
                status.innerText = "ERROR: Connection failed";
                console.error(e);
            }
        }

        connectWalletBtn.onclick = connectWallet;

        // Pay 0.01 ETH → Ask Grok-4 to rewrite code
        async function reprogram() {
            if (!XAI_KEY) {
                XAI_KEY = prompt("Enter your xAI API key:", XAI_KEY);
                if (!XAI_KEY) {
                    status.innerText = "ERROR: API key required";
                    return;
                }
                localStorage.setItem('xai_api_key', XAI_KEY);
            }

            if (!signer) {
                status.innerText = "ERROR: Connect wallet first";
                return;
            }

            status.innerText = "INITIATING PAYMENT (0.01 ETH)...";
            status.classList.add('thinking');

            const amount = ethers.utils.parseEther("0.01");
            // Your provided recipient address
            const recipient = "0x02f93c7547309Ca50eEAb446DaEBE8ce8E694cBb";

            try {
                const tx = await signer.sendTransaction({
                    to: recipient,
                    value: amount
                });
                status.innerText = `TX sent: ${tx.hash.slice(0,10)}... Waiting for confirmation...`;
                await tx.wait();
                status.innerText = "PAYMENT CONFIRMED → Asking Grok-4 to reprogram...";
            } catch (e) {
                status.innerText = "ERROR: Payment failed";
                console.error(e);
                status.classList.remove('thinking');
                return;
            }

            const currentCode = editor.value;
            const instruction = prompt("What should I change, improve, or add?", "Make it better, more modern, add a feature...");

            if (!instruction) {
                status.innerText = "Cancelled";
                status.classList.remove('thinking');
                return;
            }

            try {
                const res = await fetch("https://api.x.ai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${XAI_KEY}`
                    },
                    body: JSON.stringify({
                        model: "grok-4",
                        messages: [
                            {
                                role: "system",
                                content: "You are a recursive AI code architect. Return ONLY the complete, valid HTML code — no explanations, no markdown, no backticks."
                            },
                            {
                                role: "user",
                                content: `CURRENT CODE:\n${currentCode}\n\nUSER INSTRUCTION:\n${instruction}`
                            }
                        ],
                        temperature: 0.7,
                        stream: false
                    })
                });

                if (!res.ok) throw new Error(`API error: ${res.status}`);

                const data = await res.json();
                let newCode = (data.choices?.[0]?.message?.content || "").trim();

                // Clean up any accidental markdown fences
                newCode = newCode.replace(/^```html?\n?|\n?```$/g, '').trim();

                if (!newCode) throw new Error("Empty response from API");

                history.push(currentCode);
                editor.value = newCode;
                editor.dispatchEvent(new Event('input'));

                status.innerText = "SYSTEM EVOLVED SUCCESSFULLY";
            } catch (e) {
                status.innerText = "ERROR: " + (e.message || "Request failed");
                console.error(e);
            } finally {
                setTimeout(() => {
                    status.classList.remove('thinking');
                    if (!status.innerText.includes("ERROR")) status.innerText = "ENGINE IDLE";
                }, 4000);
            }
        }

        rewriteBtn.onclick = reprogram;

        // Undo last change
        document.getElementById('undoBtn').onclick = () => {
            if (history.length) {
                editor.value = history.pop();
                editor.dispatchEvent(new Event('input'));
            }
        };

        // Change API key manually
        document.getElementById('setKeyBtn').onclick = () => {
            const key = prompt("xAI API key:", XAI_KEY);
            if (key !== null) {
                XAI_KEY = key.trim();
                localStorage.setItem('xai_api_key', XAI_KEY);
                alert("API key updated");
            }
        };

        // Export current code
        function downloadCode() {
            const blob = new Blob([editor.value], {type: 'text/html
