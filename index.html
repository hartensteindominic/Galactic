async function processRequest() {
    const inputField = document.getElementById('user-input');
    const prompt = inputField.value.trim();
    if (!prompt) return;

    logToChat("User: " + prompt);
    logToChat("AI: Thinking autonomously...");

    try {
        // 1. Check local 'memory' (Self-Learning)
        const learnedCode = localStorage.getItem(prompt.toLowerCase());
        if (learnedCode) {
            logToChat("AI: Retaining knowledge from previous session...");
            displayCode(learnedCode);
            return;
        }

        // 2. Architecting the response
        logToChat("AI: Architecting UI components...");
        const generatedCode = await generateAutonomousCode(prompt);
        
        // 3. Self-Correction Loop
        logToChat("AI: Running internal syntax check...");
        
        // Fix: Check for <html> or the doctype
        if (generatedCode.includes("<html") || generatedCode.includes("<!DOCTYPE")) {
            logToChat("AI: Code verified. Saving to memory.");
            localStorage.setItem(prompt.toLowerCase(), generatedCode);
            displayCode(generatedCode);
        } else {
            throw new Error("Validation Failed");
        }

    } catch (err) {
        logToChat("AI Error: Attempting self-repair...");
        // Delaying the retry to prevent crashing the browser
        setTimeout(() => processRequest(), 2000); 
    }
}

async function generateAutonomousCode(topic) {
    // Return a template literal (the "Seed")
    return `<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; text-align: center; padding: 50px; }
        .card { background: #333; padding: 30px; border-radius: 15px; border: 1px solid #444; }
        h1 { color: #00ffcc; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Welcome to the ${topic} Hub</h1>
        <p>This page was generated autonomously by Gemini AI.</p>
    </div>
</body>
</html>`;
}

function displayCode(code) {
    const box = document.getElementById('chat-box');
    // Using textContent inside a <pre> tag is safer than manual escaping for UI
    const container = document.createElement('div');
    container.style = "background: #000; color: #0f0; padding: 10px; margin-top: 10px; border-radius: 5px; text-align: left;";
    container.innerHTML = `<strong>Generated Code:</strong>`;
    
    const pre = document.createElement('pre');
    pre.style = "white-space: pre-wrap; word-wrap: break-word;";
    pre.textContent = code; // Automatically escapes HTML
    
    container.appendChild(pre);
    box.appendChild(container);
}
